!> The commands used on this page are out of date and will be updated soon

The operator(s) is/are the stake holder(s) who operating a pools. The operators can define their operational costs in the pool certificate, that can be deducted from the rewards.

The objectives are the following:
  - Understand __off-chain__ `operational key certificates`,
  - the required keys and addresses,
    - `payment key(s)` for generating `base` payment addresses,
    - `stake key(s)` for generating  __pool__ `reward address(es)`,
  - the stake address registration process __with__ `key deposit` and
  - the stake pool registration procedure /w pledge and other params.

Detailed steps are:
- Run a node with an `operational key certificate`
- Create stake key registration certificate for registering the operator's stake key (`staking.key`) on the chain, then
- Create a pool registration certificate for the node to became a stake pool (`pool.cert`),
- Create a delegation certificate for the owner (operator in our exercise) to delegate its stake as pledge to the newly creating pool (`deleg.cert`).
- Sends the __on-chain__ certificates to the blockchain in one or more transactions.

#### Run a node with Operational Key Certificate

The operational key certificates use an __operational key__ (cold) key to grant the right to sign blocks to another key (KES) that will expire after some epochs, that is based on the genesis parameters. 

It uses a similar mechanism to the `forward secure signature scheme` where the signing key (KES) changes over time period and the end of each time period a new signing key is computed for the next peried and the old one is erased. 

The mechanism used for running a node with `operational key certificates` are the following: 
 1. KES (Key Evolving Signatures) that creates new (hot) KES keys periodically from the cold key
    - Create the cold (offline) key pair,
    - Create the hot KES key pairs (periodically), for signing blocks.
    - Create the `operational key certificate`
 2. Generate VRF key pair for leader selection (lottery).
 3. Run stake pool that is using the
   - non expired Operational certificate
   - non expired KES (hot) signing key
   - VRF signing key


Before the old hot (KES) key pair is expiring, a new `operational key certificate` needs to be created by using a newly generated hot (KES) key pair and the __off-line__ cold signing key.

In production environment, it is expected that the cold key is generated by some seed generation mechanism (BIP39 or similar) and stored on computer that does not have access to the Internet and when the time arrives, the operational certificates with the hot (KES) key pairs are transferred, by some mechanism (USB stick, air gapped QR etc.) to the stake pool.

``` bash
# 1.1 Create cold key pair
##########################################
pushd  $CNODE_HOME && mkdir -p ~/cold-keys && pushd ~/cold-keys || exit 127

# Generate the cold offline key pair
cardano-cli shelley node key-gen \
    --verification-key-file cold.vkey \
    --signing-key-file cold.skey \
    --operational-certificate-issue-counter cold.counter
popd

# 1.2 Generate a new hot KES keypair 
cardano-cli shelley node key-gen-KES --verification-key-file priv/kes.vkey --signing-key-file priv/kes.skey

# 1.3 Generate the ops cert based on 
# - the `cold signing key`
# - the hot KES key and
# - the cold key's counter
# New periodic cert is based on the new hot KES key.
# kes-period tells how long the ops cert therefrore the hot KES keys are valid
#
cardano-cli shelley node issue-op-cert \
    --cold-signing-key-file ~/cold-keys/cold.skey \
    --operational-certificate-issue-counter ~/cold-keys/cold.counter \
    --hot-kes-verification-key-file priv/kes.vkey \
    --kes-period 0 \
    --out-file priv/op.cert

# 2. Generate VRF key pair for leader selection
#########################################################
cardano-cli shelley node key-gen-VRF --verification-key-file priv/vrf.vkey --signing-key-file priv/vrf.skey

# 3. Run node /w these new keys generated
#########################################################

cardano-node run \
  --config                          files/config.json \
  --topology                        files/topology.json \
  --database-path                   db \
  --socket-path                     sockets/nodes.socket \
  --shelley-kes-key                 priv/kes.skey \
  --shelley-vrf-key                 priv/vrf.skey \
  --shelley-operational-certificate priv/op.cert \
  --port                            6000 

```

I will use the initial genesis address as input for registering the:
- delegate registration certificate and
- pool registration certificate

> Keep in mind the operator also need to have its stake key registered onn the chain.

#### Create stake key registration certificate

First we need to create the operator's key in order to register the key on the chain.

The delegate's `staking key` needs to be registered on the blockchain in order to participating in staking, which just need a simple transaction using any `payment address`.

> This is the pool operators's stake key, and not the delegate's one. 
Therefore I prefixed them it differently i.e. `staking`, to distuinguish between the delegate's (`stake`) prefix.

``` bash
mkdir operator && pushd operator

# Generate the operator's stake keys
cardano-cli shelley stake-address key-gen --verification-key-file staking.vkey --signing-key-file staking.skey

# crate teh reward (staking) address from the operator's stake keys
cardano-cli shelley stake-address build --stake-verification-key-file staking.vkey --testnet-magic 42 > staking.addr

# Generate the operator's payment keys
cardano-cli shelley address key-gen --verification-key-file op_pay.vkey --signing-key-file op_pay.skey

# Generate an `enterprise` address for the operator.
cardano-cli shelley address build --payment-verification-key-file op_pay.vkey --testnet-magic 42 > op_pay.addr

# Generate the base address  i.e. compount `enterprise || reward` address
cardano-cli shelley address build \
    --payment-verification-key-file op_pay.vkey \
    --stake-verification-key-file staking.vkey \
    --testnet-magic 42 > base.addr
```

The next step is creating a stake address registration certificate.

For registering an `stake key` on the chain a `key deposit1` fee must be paid. The amount can be optained from the genesis for the params file e.g.:
``` bash
cardano-cli shelley query protocol-parameters --testnet-magic 42 | tee params.json | jq -r .keyDeposit
400000
```

Generate the operator's stake key registration certificate 

Keep, in mind that the a `key registration certificates` needs a deposit (__keyDeposit__ in genesis) for the costs of tracking the key and the corresponding reward account. Also, it does not require any witness to register the certificate, but only the witness for the fees from the input of the transaction.



``` bash
# Keep in mind that this certificates needs a `keyDeposit` specified in the genesis.
cardano-cli shelley stake-address registration-certificate \
    --stake-verification-key-file staking.vkey \
    --out-file staking.cert
# The certificate contains the `blake2b-256` hash of the stake verifying key

# Calculate the min fee for the following outputs:
# 1. the base address that will contain the funds for pledge
# 2. And the change address.
# Keep in mind just one signing key is required, the paying signing key,
# as stake key reg cert does not need t obe witnessed
cardano-cli shelley transaction calculate-min-fee \
    --tx-in-count 1 \
    --tx-out-count 2 \
    --ttl 500000 \
    --testnet-magic 42 \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --certificate-file staking.cert \
    --protocol-params-file params.json
# 
# runTxCalculateMinFee: 174169

# INPUT will be based on the genesis addres (FROM)
# but any pay address is fine.
FROM="617190446876aed298ee207c6b5a335e832e2169a060b8167ef3ba9caff6fa3393"

cardano-cli shelley query utxo --testnet-magic 42 --address "$FROM"
#                           TxHash                                 TxIx        Lovelace
#----------------------------------------------------------------------------------------
#c85b72ee021915f5a8349209db54a51334ad9dfcec2f0fa2619a707556017bb3     0      499999825831

INPUT="c85b72ee021915f5a8349209db54a51334ad9dfcec2f0fa2619a707556017bb3#0"
BALANCE=499999825831
# The amount will be 400K and I will pladge all of it to the pool
AMOUNT=400000000000
KEYDEP=400000
FEE=174169
CHANGE="$FROM+$(( 499999825831 - $FEE - $KEYDEP - $AMOUNT ))"


# So, I used the genesis UtxO to move to some staking (group) address and 500K back to it.
cardano-cli shelley transaction build-raw \
    --tx-in "$INPUT" \
    --tx-out $(cat base.addr)+$AMOUNT \
    --tx-out "$CHANGE" \
    --ttl 500000 \
    --fee "$FEE" \
    --out-file staking-cert.tx \
    --certificate-file staking.cert

# Sign it
cardano-cli shelley transaction sign \
    --tx-body-file staking-cert.tx \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --testnet-magic 42 \
    --out-file signed-staking-cert.tx

# Submit it
cardano-cli shelley transaction submit \
    --tx-file signed-staking-cert.tx \
    --testnet-magic 42
```

#### Create a pool registration  certificate

A node needs a `pool certificate` registered on the blockchain for the operator to became a stake pool (`pool.cert`),

Now we have a 400K on the operator's `base address` and the stake key (`staking.key`) is registered.
``` bash 
cardano-cli shelley query utxo --testnet-magic 42 --address $(cat base.addr)
                           TxHash                                 TxIx        Lovelace
----------------------------------------------------------------------------------------
863506d0e7d1afcdb558ac4b021f2e7746f3c3178faecd11e1f0349ded141a74     0      400000000000
```

In the operator's PoV, for registering a pool, the pool certificate must contain:
- a `node operational verifying key` a.k.a. `cold key`, for generating the pool id.
- the `VRF verifyig key` a.k.a `hot key`, for lottery, to prove that the node has the right to create and sign a block,
- an operator `stake verifying keys` for generating the reward address, where the pool rewards would be sent and
- owner's `stake verifying keys` generating the pledge `staking` address, that has enough fund for pledging.

> Note: the `reward account verification key` and the `owner staking verification key` can be the same is, see below example, if the operator is the owner too.

Also, for registering a pool certificate a `pool deposit` must be paid too.

``` bash
# Createing a pools cert with
# - 400K of the owner's (operator in this example) 400K pledge, 
# - 1k as cost /w 
# - 5% margin
cardano-cli shelley stake-pool registration-certificate \
    --cold-verification-key-file ~/cold-keys/pool.vkey \
    --vrf-verification-key-file $CNODE_HOME/priv/vrf.vkey \
    --pool-pledge 400000000000 \
    --pool-cost 1000000000 \
    --pool-margin 0.05 \
    --reward-account-verification-key-file staking.vkey \
    --pool-owner-staking-verification-key staking.vkey \
    --out-file pool.cert
```

#### Create (the stake owner's) delegation certificate

For __pledging__, the owner (in our example the operator) must create a `stake delegation certificate` for delegating at least a `pledge` amount of stake from the owner's `staking key` specified in the pool certificate.

In simple words, the owner is delegating its funds (`pledge`) to the pool he/she owns.

``` bash 
cardano-cli shelley stake-address delegation-certificate \
    --stake-verification-key-file staking.vkey \
    --cold-verification-key-file ~/cold-keys/pool.vkey \
    --out-file owner-delegation.cert
```

#### Submit the certificate to the chain

The certificates can be sent in one transaction.
> Please, keep in mind that the registering a pool the operator's must pay a (decaying) `pool deposit` fee.

```
# grep -i poolDeposit params.json
#  "poolDeposit": 500000000,
# or 
# cardano-cli shelley query  protocol-parameters --testnet-magic 42 | jq '.poolDeposit'
# 500000000


# Calculate the fee for sending the both certificates the
# - pool registration certificate and the
# - owner's (in our case the operator's) delegating certificate.
#
# Also, it will be paid by my genesis key, but any valid `payment` signing key would do that 
# has the fee and the deposit
cardano-cli shelley transaction calculate-min-fee \
    --tx-in-count 1 \
    --tx-out-count 1 \
    --ttl 500000 \
    --testnet-magic 42 \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --signing-key-file staking.skey \
    --signing-key-file ~/cold-keys/pool.skey \
    --certificate-file pool.cert \
    --certificate-file owner-delegation.cert \
    --protocol-params-file ../params.json
# runTxCalculateMinFee: 184377

FEE=184377
POOLDEP=500000000

cardano-cli shelley query utxo --testnet-magic 42 --address "$FROM"
#                           TxHash                                 TxIx        Lovelace
#----------------------------------------------------------------------------------------
#863506d0e7d1afcdb558ac4b021f2e7746f3c3178faecd11e1f0349ded141a74     1       99999251662

BALANCE=99999251662
INPUT="863506d0e7d1afcdb558ac4b021f2e7746f3c3178faecd11e1f0349ded141a74#1"
CHANGE="$FROM+$(( $BALANCE - $FEE - $POOLDEP ))"

# Build
cardano-cli shelley transaction build-raw \
     --tx-in "$INPUT" \
     --tx-out "$CHANGE" \
     --ttl 500000 \
     --fee "$FEE" \
     --out-file pool-cert.tx \
     --certificate-file pool.cert \
     --certificate-file owner-delegation.cert 

# Sign
# - the `genesis.skey` needs for signing the payment from the $FROM address.
# - the `staking.skey` needs for signing the owner's delegation certificate.
# - the `pool.skey` needs for signing the pool's registration certificate.
cardano-cli shelley transaction sign \
    --tx-body-file pool-cert.tx \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --signing-key-file staking.skey \
    --signing-key-file ~/cold-keys/pool.skey \
    --testnet-magic 42 \
    --out-file signed-pool-cert.tx

# Submit:
cardano-cli shelley transaction submit \
    --tx-file signed-pool-cert.tx \
    --testnet-magic 42

```
Done your pool is registered.

To check it you can you the following command:

``` bash
# Get the Pool Id whihc is in the owner-delegation.cert
POOL_ID=$( tail -1 owner-delegation.cert | cut -c 6- )
echo $POOL_ID
# 5820d07e860c52860d92373893b27d6926e6610c925f905eba40d8e930004bf2dc44
shelley query ledger-state  --testnet-magic 42 | grep "poolPubKey" | grep  "$POOL_ID"
#                    "_poolPubKey": "d07e860c52860d92373893b27d6926e6610c925f905eba40d8e930004bf2dc44",
```

